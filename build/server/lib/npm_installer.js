// Generated by CoffeeScript 1.10.0
var BASE_PACKAGE_JSON, config, createAppFolder, directory, executeUntilEmpty, fs, log, makeCommandsProxy, mkdirp, patchCommandsCoffe, path;

path = require('path');

fs = require('fs');

mkdirp = require('mkdirp');

directory = require('./directory');

executeUntilEmpty = require('../helpers/executeUntilEmpty');

config = require('./conf').get;

log = require('printit')({
  date: true,
  prefix: 'lib:npm-installer'
});

BASE_PACKAGE_JSON = "{\n  \"name\": \"cozy-controller-fake-package.json\",\n  \"version\": \"1.0.0\",\n  \"description\": \"This file is here to please NPM\",\n  \"README\":  \"This file is here to please NPM\",\n  \"license\": \"N/A\",\n  \"repository\": \"N/A\"\n}";

makeCommandsProxy = function(trueCommandsFile) {
  return "{spawn} = require 'child_process'\n{dirname} = require 'path'\nargs = [\"" + trueCommandsFile + "\"].concat process.argv[2..]\nspawn 'coffee', args,\n     stdio: 'inherit'\n     cwd: dirname " + trueCommmandsFile;
};

createAppFolder = function(app, callback) {
  var dirPath, packagePath;
  dirPath = path.join(config('dir_app_bin'), app.name);
  packagePath = path.join(dirPath, 'package.json');
  return mkdirp(dirPath, "0711", function(err) {
    if (err) {
      return callback(new Error("Failed to create folder " + dirPath + " : " + err.message));
    }
    return fs.writeFile(packagePath, BASE_PACKAGE_JSON, 'utf8', function(err) {
      if (err) {
        return callback(new Error("Failed to create package.json " + packagePath + " : " + err.message));
      }
      return directory.changeOwner(app.user, dirPath, function(err) {
        if (err) {
          return callback(new Error("Failed to changeOwner " + dirPath + " : " + err.message));
        }
        return callback(null, dirPath);
      });
    });
  });
};


/*
HACK
A lot of our infra code depends on the /usr/local/cozy/apps/home/commands.coffee
file. This function create a commands.cofee file at the expected location
which proxies its calls to the actual commands.coffee in
/usr/local/cozy/apps/home/node_modules/cozy-home/commands.coffee.
@TODO
- Move all of the commands.coffee commands to the cozy_management
- Use the cozy_management in infra scripts
- Remove this function
 */

patchCommandsCoffe = function(app, callback) {
  var dirPath, expectedPath, pname, ref, truePath;
  pname = ((ref = app["package"]) != null ? ref.name : void 0) || app["package"];
  dirPath = path.join(config('dir_app_bin'), app.name);
  expectedPath = path.join(dirPath, 'commands.coffee');
  truePath = path.resolve(dirPath, 'node_modules', pname, 'commands.coffee');
  return fs.writeFile(expectedPath, makeCommandsProxy(truePath), 'utf8', function(err) {
    if (err) {
      return callback(err);
    }
    return directory.changeOwner(app.user, expectedPath, function(err) {
      if (err) {
        return callback(err);
      }
      return callback(null);
    });
  });
};


/*
    Initialize repository of <app>
        * Run npm install <app> in the apps dir
 */

module.exports.init = function(app, callback) {
  var ref;
  if (!((ref = app["package"]) != null ? ref.name : void 0)) {
    return callback(new Error("Tried to npm_installer.init a non NPM app : " + (JSON.stringify(app))));
  }
  return createAppFolder(app, function(err, appFolder) {
    var commands, opts;
    if (err) {
      return callback(err);
    }
    commands = [['npm', 'install', app.fullnpmname]];
    opts = {
      user: app.user,
      cwd: appFolder
    };
    return executeUntilEmpty(commands, opts, function(err) {
      if (err != null) {
        log.error(err);
        log.error("FAILLED TO RUN CMD", err);
        return callback(err);
      } else {
        return patchCommandsCoffe(app, callback);
      }
    });
  });
};


/*
    Update repository of <app>
        * Run npm install <app> in the apps dir
 */

module.exports.update = function(app, callback) {
  var commands, opts;
  commands = [['npm', 'install', app.fullnpmname]];
  opts = {
    user: app.user,
    cwd: config('dir_app_bin')
  };
  return executeUntilEmpty(commands, opts, function(err) {
    if (err) {
      log.error(err);
      return log.error("failed to remove app");
    } else {
      return callback();
    }
  });
};


/*
    Change branch of <app>
        * Run npm install <app>@<newBranch> in the apps dir
 */

module.exports.changeBranch = function(app, newBranch, callback) {
  var commands, newFullName, opts;
  newFullName = app["package"].name + "@" + app["package"].version;
  commands = [['npm', 'install', newFullName]];
  opts = {
    cwd: config('dir_app_bin'),
    user: app.user
  };
  return executeUntilEmpty(commands, opts, function(err) {
    if (err) {
      log.error(err);
      return log.error("failed to remove app");
    } else {
      app["package"].version = newBranch;
      return callback();
    }
  });
};
